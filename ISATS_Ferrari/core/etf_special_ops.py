"""
ğŸš€ ISATS v6.0 - ETF Special Ops (íŠ¹ìˆ˜ê¸°ë™ëŒ€)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ì‘ì „ëª…: "Bi-Directional Switching - ì–‘ë°©í–¥ ìˆ˜ìµ êµ¬ì¡°"

ì—­í• :
- ì‹œì¥ êµ­ë©´ íŒë… (BOOM/CRASH/BULL/BEAR/SIDE)
- í­ë“± ì‹œ: TQQQ/SOXL ì§„ì… (3ë°° ë ˆë²„ë¦¬ì§€)
- í­ë½ ì‹œ: SQQQ/SOXS ì§„ì… (3ë°° ì¸ë²„ìŠ¤)
- ê°œë³„ ì¢…ëª© 10% + ì¸ë²„ìŠ¤ ìˆ˜ìµ = ì–‘ë°©í–¥ ìˆ˜ìµ

ì‘ì„±ì: ISATS Neural Swarm
ë²„ì „: 6.0 (ETF Special Ops)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
"""

import asyncio
import os
import sys
from datetime import datetime
from typing import Dict, List, Tuple

# í”„ë¡œì íŠ¸ ë£¨íŠ¸
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ì„ íƒì  ì„í¬íŠ¸
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

try:
    import pandas as pd
    import numpy as np
    HAS_PANDAS = True
except ImportError:
    HAS_PANDAS = False

try:
    import FinanceDataReader as fdr
    HAS_FDR = True
except ImportError:
    HAS_FDR = False
    print("âš ï¸ [Warning] FinanceDataReader not found. Installing...")
    os.system("pip install finance-datareader --quiet")
    import FinanceDataReader as fdr
    HAS_FDR = True


# ==========================================
# ğŸ›¡ï¸ Risk Manager v3.0 (Regime Classifier)
# ==========================================

class MarketRiskManager:
    """ì‹œì¥ êµ­ë©´ íŒë…ê¸° - "Chaos is a Ladder" """
    
    def __init__(self, market: str = "US"):
        """
        Args:
            market: ì‹œì¥ (US/KR)
        """
        self.market = market
        
        # ì‹œì¥ ì§€ìˆ˜
        self.index_ticker = "IXIC" if market == "US" else "KS11"  # ë‚˜ìŠ¤ë‹¥ / ì½”ìŠ¤í”¼
        
        # ì„ê³„ê°’ ì„¤ì •
        self.vol_threshold = 2.0  # ë³€ë™ì„±ì´ í‰ì†Œì˜ 2ë°° ì´ìƒì´ë©´ 'ì´ë²¤íŠ¸' ë°œìƒ
        self.trend_window = 20    # 20ì¼ ì´ë™í‰ê· ì„  (ë‹¨ê¸° ì¶”ì„¸)
    
    def check_market_regime(self) -> Tuple[str, str]:
        """
        ì‹œì¥ êµ­ë©´ íŒë… (Regime Detection)
        
        Returns:
            Tuple[str, str]: (êµ­ë©´, ì„¤ëª…)
            - êµ­ë©´: 'BOOM', 'CRASH', 'BULL', 'BEAR', 'SIDE'
        """
        try:
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # 1. ìµœê·¼ 120ì¼ ë°ì´í„° ì¡°íšŒ
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            df = fdr.DataReader(self.index_ticker)
            
            if len(df) < 60:
                return "SIDE", "ë°ì´í„° ë¶€ì¡±"
            
            current_price = df['Close'].iloc[-1]
            ma20 = df['Close'].rolling(self.trend_window).mean().iloc[-1]
            
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # 2. ë³€ë™ì„±(Turbulence) ê³„ì‚°
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            recent_vol = df['Close'].pct_change().tail(5).std()
            avg_vol = df['Close'].pct_change().tail(60).std()
            turbulence = recent_vol / (avg_vol + 1e-8)
            
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # 3. ì¶”ì„¸ í™•ì¸
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            is_uptrend = current_price > ma20
            
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            # 4. êµ­ë©´ íŒë‹¨ (Matrix)
            # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
            
            if turbulence > self.vol_threshold:
                # ë³€ë™ì„±ì´ í„°ì¡ŒëŠ”ë°
                if is_uptrend:
                    return "BOOM", f"ğŸš€ [BOOM] í­ë“± ì¥ì„¸! ë³€ë™ì„± {turbulence:.1f}ë°° + ìƒìŠ¹ ì¶”ì„¸"
                else:
                    return "CRASH", f"ğŸ“‰ [CRASH] í­ë½ ì¥ì„¸! ë³€ë™ì„± {turbulence:.1f}ë°° + ì¶”ì„¸ ë¶•ê´´"
            
            # ë³€ë™ì„±ì€ í‰ë²”í•œë°
            elif is_uptrend:
                return "BULL", "ğŸ“ˆ [BULL] ì™„ë§Œí•œ ìƒìŠ¹ì¥"
            else:
                return "BEAR", "â˜ï¸ [BEAR] ì™„ë§Œí•œ í•˜ë½ì¥"
        
        except Exception as e:
            return "SIDE", f"Error: {e}"
    
    def get_etf_strategy(self, regime: str) -> Tuple[str, List[str]]:
        """
        êµ­ë©´ì— ë”°ë¥¸ ìµœì  ETF ì „ìˆ  ì œì•ˆ
        
        Args:
            regime: ì‹œì¥ êµ­ë©´
        
        Returns:
            Tuple[str, List[str]]: (ë°©í–¥, ETF ë¦¬ìŠ¤íŠ¸)
        """
        if self.market == "US":
            # ë‚˜ìŠ¤ë‹¥/ë°˜ë„ì²´ ê¸°ì¤€
            if regime == "BOOM" or regime == "BULL":
                return "LONG", ["TQQQ", "SOXL"]  # 3ë°° ë ˆë²„ë¦¬ì§€
            elif regime == "CRASH" or regime == "BEAR":
                return "SHORT", ["SQQQ", "SOXS"]  # 3ë°° ì¸ë²„ìŠ¤
        
        else:  # KR
            # ì½”ìŠ¤í”¼200/ì½”ìŠ¤ë‹¥150 ê¸°ì¤€
            if regime == "BOOM" or regime == "BULL":
                return "LONG", ["122630", "233740"]  # KODEX ë ˆë²„ë¦¬ì§€ / ì½”ìŠ¤ë‹¥150 ë ˆë²„ë¦¬ì§€
            elif regime == "CRASH" or regime == "BEAR":
                return "SHORT", ["252670", "251340"]  # KODEX 200ì„ ë¬¼ì¸ë²„ìŠ¤2X / ì½”ìŠ¤ë‹¥150ì„ ë¬¼ì¸ë²„ìŠ¤
        
        return "HOLD", []


# ==========================================
# ğŸ‘® ETF Special Ops (íŠ¹ìˆ˜ê¸°ë™ëŒ€)
# ==========================================

class ETFSpecialOps:
    """ETF íŠ¹ìˆ˜ê¸°ë™ëŒ€ - ì§€ìˆ˜ë§Œ ë…¸ë ¤ë³´ëŠ” ì „ë¬¸ê°€ë“¤"""
    
    def __init__(self, market: str = "US"):
        """
        Args:
            market: ì‹œì¥ (US/KR)
        """
        self.market = market
        self.risk_manager = MarketRiskManager(market)
        self.current_regime = "SIDE"
        self.current_position = None
    
    async def patrol(self) -> Dict:
        """
        ì‹œì¥ ìˆœì°° (êµ­ë©´ íŒë…)
        
        Returns:
            Dict: ìˆœì°° ê²°ê³¼
        """
        print(f"\n{'='*80}")
        print(f"ğŸ‘® ETF Special Ops ìˆœì°° ì‹œì‘ ({self.market})")
        print(f"{'='*80}\n")
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 1. ì‹œì¥ êµ­ë©´ íŒë…
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        regime, description = self.risk_manager.check_market_regime()
        self.current_regime = regime
        
        print(f"ğŸ“Š ì‹œì¥ êµ­ë©´: {description}")
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 2. ETF ì „ìˆ  ê²°ì •
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        direction, etf_list = self.risk_manager.get_etf_strategy(regime)
        
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        # 3. ì‘ì „ ëª…ë ¹
        # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
        
        if direction == "LONG":
            print(f"\nğŸš€ [ì‘ì „ ëª…ë ¹] ë ˆë²„ë¦¬ì§€ ì§„ì…!")
            print(f"   ì¶”ì²œ ETF: {', '.join(etf_list)}")
            print(f"   ì „ëµ: 3ë°° ë ˆë²„ë¦¬ì§€ë¡œ í­ë“± ìˆ˜ìµ ê·¹ëŒ€í™”")
        
        elif direction == "SHORT":
            print(f"\nğŸ“‰ [ì‘ì „ ëª…ë ¹] ì¸ë²„ìŠ¤ ì§„ì…!")
            print(f"   ì¶”ì²œ ETF: {', '.join(etf_list)}")
            print(f"   ì „ëµ: 3ë°° ì¸ë²„ìŠ¤ë¡œ í­ë½ ìˆ˜ìµ ê·¹ëŒ€í™”")
        
        else:
            print(f"\nâ¸ï¸ [ì‘ì „ ëª…ë ¹] ëŒ€ê¸°")
            print(f"   í˜„ì¬ êµ­ë©´ì—ì„œëŠ” ETF ì§„ì… ë³´ë¥˜")
        
        print(f"\n{'='*80}\n")
        
        return {
            "regime": regime,
            "description": description,
            "direction": direction,
            "etf_list": etf_list,
            "timestamp": datetime.now().isoformat()
        }


# ==========================================
# ì‹¤í–‰
# ==========================================

async def main():
    """ETF íŠ¹ìˆ˜ê¸°ë™ëŒ€ í…ŒìŠ¤íŠ¸"""
    
    print(f"\n{'='*80}")
    print(f"ğŸš€ ETF Special Ops ê°€ë™")
    print(f"{'='*80}\n")
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ë¯¸êµ­ ì‹œì¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    us_ops = ETFSpecialOps(market="US")
    us_result = await us_ops.patrol()
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # í•œêµ­ ì‹œì¥
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    kr_ops = ETFSpecialOps(market="KR")
    kr_result = await kr_ops.patrol()
    
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    # ìµœì¢… ë³´ê³ 
    # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    
    print(f"\n{'='*80}")
    print(f"ğŸ“Š ìµœì¢… ë³´ê³ ")
    print(f"{'='*80}")
    print(f"   ë¯¸êµ­ ì‹œì¥: {us_result['regime']} â†’ {us_result['direction']}")
    print(f"   í•œêµ­ ì‹œì¥: {kr_result['regime']} â†’ {kr_result['direction']}")
    print(f"{'='*80}\n")


if __name__ == "__main__":
    asyncio.run(main())
